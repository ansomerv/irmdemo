name: Sync GitHub Labels to IRM Incident

on:
  issues:
    types: [labeled]

jobs:
  sync-label:
    runs-on: ubuntu-latest

    steps:
      - name: Extract IRM Incident ID
        id: extract
        run: |
          body="${{ github.event.issue.body }}"
          irm_incident_id=$(echo "$body" | tr -d '\r' | grep -Eio 'incident[ _]?id[^0-9]*[0-9]+' | grep -Eo '[0-9]+' | head -n1)

          if [ -z "$irm_incident_id" ]; then
            echo "No IRM Incident ID found, skipping sync."
            exit 0
          fi

          echo "IRM Incident ID: $irm_incident_id"
          echo "irm_incident_id=$irm_incident_id" >> $GITHUB_OUTPUT

      - name: Sync GitHub Label ‚Üí Grafana IRM (AddField-only)
        if: ${{ steps.extract.outputs.irm_incident_id != '' }}
        env:
          IRM_API_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY_INCIDENT }}
          STACK_URL: https://ep.amer.cloud.demokit.grafana.com
        run: |
          set -euo pipefail

          label_raw="${{ github.event.label.name }}"
          label_color="${{ github.event.label.color }}"
          label_description="${{ github.event.label.description || '' }}"
          irm_incident_id="${{ steps.extract.outputs.irm_incident_id }}"

          # Parse key:value or default to githubLabel
          if [[ "$label_raw" == *:* ]]; then
            key="${label_raw%%:*}"
            value="${label_raw#*:}"
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
          else
            key="githubLabel"
            value="$label_raw"
          fi

          echo "[STEP] Parsed label -> key='$key', value='$value'"

          # 1Ô∏è‚É£ Fetch IRM fields
          STATUS_CODE=$(curl -s -o fields.json -w "%{response_code}" \
            -X POST \
            -H "Authorization: Bearer $IRM_API_KEY" \
            -H "Content-Type: application/json" \
            "$STACK_URL/api/plugins/grafana-irm-app/resources/api/FieldsService.GetFields" \
            -d '{}')

          if [ "$STATUS_CODE" != "200" ]; then
            echo "[ERROR] Failed to fetch fields list. HTTP $STATUS_CODE"
            cat fields.json
            exit 42
          fi

          # 2Ô∏è‚É£ Check if both key and value exist
          field_exists=$(jq -r --arg key "$key" '.fields[] | select(.name==$key) | .name' fields.json | head -n1 | xargs)
          value_exists=$(jq -r --arg key "$key" --arg val "$value" '.fields[] | select(.name==$key) | .selectoptions[]? | select(.value==$val) | .value' fields.json | head -n1 | xargs)

          if [ -n "$field_exists" ] && [ -n "$value_exists" ]; then
            echo "[OUTPUT] Field '$key' with value '$value' already exists. Skipping AddField."
          else
            echo "[STEP] Adding new field '$key' with value '$value'..."
            slug=$(echo "$key" | tr '[:upper:] ' '[:lower:]_')
            selectoptions=$(jq -n '[{ value: $ARGS.named.val, label: $ARGS.named.val }]' --arg val "$value")

            payload=$(jq -n \
              --arg name "$key" \
              --arg slug "$slug" \
              --argjson selectoptions "$selectoptions" \
              '{
                field: {
                  name: $name,
                  slug: $slug,
                  type: "single-select",
                  domainName: "labels",
                  source: "incident",
                  archived: false,
                  version: 1,
                  selectoptions: $selectoptions
                }
              }')

            STATUS_CODE=$(curl -s -o add_field.json -w "%{response_code}" \
              -X POST \
              -H "Authorization: Bearer $IRM_API_KEY" \
              -H "Content-Type: application/json" \
              "$STACK_URL/api/plugins/grafana-irm-app/resources/api/FieldsService.AddField" \
              -d "$payload")

            if [ "$STATUS_CODE" = "200" ]; then
              echo "[OUTPUT] Successfully created new field '$key' with value '$value'"
            else
              echo "[ERROR] Failed to create field '$key'. HTTP $STATUS_CODE"
              cat add_field.json
              exit 42
            fi
          fi

          # 3Ô∏è‚É£ Add label to the IRM incident
          echo "[STEP] Adding label '$key:$value' to incident $irm_incident_id..."
          payload=$(jq -n \
            --arg incidentID "$irm_incident_id" \
            --arg key "$key" \
            --arg label "$value" \
            --arg colorHex "#$label_color" \
            --arg description "$label_description" \
            '{
              incidentID: $incidentID,
              label: {
                key: $key,
                label: $label,
                colorHex: $colorHex,
                description: $description
              }
            }')

          echo "üì¶ Payload:"
          echo "$payload" | jq .

          STATUS_CODE=$(curl -s -L -o add_label.json -w "%{response_code}" \
            -X POST \
            -H "Authorization: Bearer $IRM_API_KEY" \
            -H "Content-Type: application/json; charset=utf-8" \
            "$STACK_URL/api/plugins/grafana-irm-app/resources/api/v1/IncidentsService.AddLabel" \
            -d "$payload")

          echo "üì¨ Response (HTTP $STATUS_CODE):"
          cat add_label.json | jq .
