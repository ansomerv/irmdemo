name: Add Label to Grafana IRM

on:
  issues:
    types: [labeled]

jobs:
  add_label_to_grafana:
    runs-on: ubuntu-latest
    env:
      IRM_API_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY_INCIDENT }}
      STACK_URL: https://ep.amer.cloud.demokit.grafana.com

    steps:
      - name: Extract label and issue info
        id: extract
        run: |
          echo "LABEL_NAME=${{ github.event.label.name }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
          echo "ISSUE_BODY=$(echo "${{ github.event.issue.body }}" | jq -Rsa .)" >> $GITHUB_ENV

      - name: Parse incident ID from issue body
        id: parse_incident
        run: |
          # Expecting the issue body to contain something like: incidentID: 546
          INCIDENT_ID=$(echo $ISSUE_BODY | jq -r 'scan("incidentID[: ]+([0-9]+)") | .[0]')
          if [ -z "$INCIDENT_ID" ]; then
            echo "âŒ Could not find incidentID in issue body"
            exit 1
          fi
          echo "INCIDENT_ID=$INCIDENT_ID" >> $GITHUB_ENV

      - name: Generate UUID and add field select option
        run: |
          uuid=$(uuidgen)
          echo "Adding select option '${{ env.LABEL_NAME }}' to field..."
          curl -s -X POST "$STACK_URL/api/plugins/grafana-irm-app/resources/api/FieldsService.AddFieldSelectOption" \
            -H "Authorization: Bearer $IRM_API_KEY" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "x-grafana-org-id: 1" \
            -d "{
              \"fieldUUID\": \"b8d0d800-e1e0-450f-8ddd-05171ccdefee\",
              \"fieldSelectOption\": {
                \"uuid\": \"$uuid\",
                \"value\": \"${{ env.LABEL_NAME }}\",
                \"label\": \"${{ env.LABEL_NAME }}\",
                \"source\": \"incident\",
                \"icon\": \"tag-alt\"
              }
            }" \
            | jq '.'

      - name: Add label to Grafana incident
        run: |
          echo "Adding label '${{ env.LABEL_NAME }}' to incident ID '${{ env.INCIDENT_ID }}'..."
          curl -s -X POST "$STACK_URL/api/plugins/grafana-irm-app/resources/api/v1/IncidentsService.AddLabel" \
            -H "Authorization: Bearer $IRM_API_KEY" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"incidentID\": \"${{ env.INCIDENT_ID }}\",
              \"label\": {
                \"colorHex\": \"#ff0000\",
                \"description\": \"Customers are affected by this incident.\",
                \"key\": \"newx\",
                \"label\": \"${{ env.LABEL_NAME }}\"
              }
            }" \
            | jq '.'
